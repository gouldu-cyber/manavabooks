<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>도서 검색 | 마나바</title>
<style>
  :root { --bd:#e6e6e6; --fg:#222; --sub:#666; --bg:#fff; }
  body{ margin:0; font-family:system-ui,-apple-system,'Noto Sans KR',Segoe UI,Roboto,Arial; background:#fff; color:#222; }
  .wrap{ max-width:860px; margin:16px auto; padding:16px; }
  .title{ font-size:20px; font-weight:700; margin:6px 2px 12px; }
  .desc{ font-size:13px; color:#666; margin:0 2px 14px; }
  .row{ display:flex; gap:8px; align-items:center; }
  .search{ flex:1; padding:12px 14px; font-size:16px; border:1px solid #e6e6e6; border-radius:12px; }
  .meta{ margin:10px 2px 0; font-size:13px; color:#666; }
  .log { margin:6px 2px; font-size:12px; color:#b00020; white-space:pre-wrap }
  .box{ margin-top:12px; overflow:auto; border:1px solid #e6e6e6; border-radius:12px; }
  table{ width:100%; border-collapse:collapse; font-size:15px; }
  thead th{ text-align:left; padding:10px; border-bottom:1px solid #e6e6e6; background:#fafafa; position:sticky; top:0; }
  tbody td{ padding:10px; border-bottom:1px solid #f1f1f1; white-space:nowrap; }
  mark{ background:#ffec99; padding:0 2px; border-radius:3px; }
  .badge{ display:inline-block; padding:2px 8px; border:1px solid #d9d9d9; border-radius:999px; font-size:12px; color:#444; background:#fff; }
  @media (max-width:720px){
    tbody td:nth-child(1), thead th:nth-child(1){ display:none; }
    tbody td, thead th{ padding:8px; font-size:14px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="title">도서 검색</div>
  <p class="desc">책 제목을 입력하세요. 예) <b>원피스</b> · 결과에 <b>구역·칸·단</b> 표시</p>

  <div class="row">
    <input id="q" class="search" placeholder="예: 원피스 / 킹덤 / 나루토">
    <span id="quick" class="badge" title="앞부분 일치 우선 정렬">빠른찾기</span>
  </div>

  <div id="meta" class="meta"></div>
  <div id="log" class="log"></div>
  <div id="out" class="box" aria-live="polite"></div>
</div>

<script>
const PRIMARY_URL = "https://gouldu-cyber.github.io/manavabooks/mnvbooks.json";
const FALLBACK_URL = "https://raw.githubusercontent.com/gouldu-cyber/manavabooks/main/mnvbooks.json";

// JSON의 실제 키를 이 표준 키로 매핑해 사용
const MAP = {
  "구분": ["구분","분류"],
  "제목": ["제목","title"],
  "구역": ["구역","구역A","shelf","area"],
  "칸":   ["칸","col","slot"],
  "단":   ["단","row","level"],
  "권수": ["권수","권","vol","count"],
  "완결여부": ["완결여부","완결"],
  "결권": ["결권","마지막권","last"]
};
const COLS = ["구분","제목","구역","칸","단","권수","완결여부","결권"]; // 보여줄 순서

const qEl = document.getElementById('q');
const out  = document.getElementById('out');
const meta = document.getElementById('meta');
const log  = document.getElementById('log');
const quickEl = document.getElementById('quick');

let DATA=[], IDX=[], QUICK=true;

function norm(s){ if(s==null) return ""; return String(s).normalize('NFKD').toLowerCase().replace(/\s+/g,'').replace(/[\u0300-\u036f]/g,''); }
function esc(s){ return String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

// 소스 객체의 키 목록에서 원하는 키(대체명 포함)를 찾아 값 반환
function pick(obj, want){
  const cands = MAP[want] || [want];
  for(const k of Object.keys(obj)){
    const kk = k.trim();
    if(cands.includes(kk)) return obj[k];
  }
  return obj[want];
}

function hilite(text, raw){
  if(!raw) return esc(text);
  const s = String(text??"");
  const nText = norm(s), nKey = norm(raw);
  const i = nText.indexOf(nKey);
  if(i<0) return esc(s);
  return esc(s.slice(0,i)) + "<mark>" + esc(s.slice(i, i+raw.length)) + "</mark>" + esc(s.slice(i+raw.length));
}

async function fetchJson(url){
  const r = await fetch(url, {cache:"no-store", headers:{Accept:"application/json"}});
  if(!r.ok) throw new Error(`HTTP ${r.status} at ${url}`);
  return r.json();
}

async function load(){
  try{
    log.textContent = "데이터 로딩 중…";
    let d;
    try { d = await fetchJson(PRIMARY_URL); }
    catch(e1){ log.textContent = "기본 URL 실패, 대체 URL 시도 중…\n"+e1; d = await fetchJson(FALLBACK_URL); }

    DATA = Array.isArray(d) ? d : (d.records || []);
    if(!Array.isArray(DATA)) throw new Error("JSON 형식이 배열이 아닙니다.");

    // 인덱스(제목/구분)
    IDX = DATA.map((row,i)=>({ i, 제목:norm(pick(row,"제목")), 구분:norm(pick(row,"구분")||"") }));

    log.textContent = `로드 성공: ${DATA.length}건`;
    // ?q= 파라미터로 바로 검색
    const p = new URLSearchParams(location.search);
    if(p.get('q')){ qEl.value = p.get('q'); doSearch(); }
  }catch(e){
    log.textContent = "로딩 에러: "+e.message;
    out.innerHTML = `<div style="padding:12px;color:#b00020;">데이터를 불러오지 못했습니다. JSON 경로 또는 형식을 확인해주세요.</div>`;
  }
}
load();

let timer=null;
qEl.addEventListener('input', ()=>{ clearTimeout(timer); timer=setTimeout(doSearch, 120); });
quickEl.addEventListener('click', ()=>{ QUICK=!QUICK; quickEl.textContent=QUICK?"빠른찾기":"유사찾기"; doSearch(); });

function doSearch(){
  const raw = qEl.value.trim();
  if(!raw){ out.innerHTML=""; meta.textContent=""; return; }
  const key = norm(raw);

  let hits = IDX.filter(x => x.제목.includes(key) || x.구분.includes(key));
  hits.sort((a,b)=>{
    if(QUICK){
      const ap = Number(a.제목.startsWith(key)), bp = Number(b.제목.startsWith(key));
      return bp - ap || a.제목.indexOf(key) - b.제목.indexOf(key);
    }else{
      return a.제목.indexOf(key) - b.제목.indexOf(key);
    }
  });

  meta.textContent = `검색어: "${raw}" · 결과 ${hits.length}건`;

  if(hits.length===0){ out.innerHTML = `<div style="padding:12px;">검색 결과가 없습니다.</div>`; return; }

  const rows = hits.slice(0,1000).map(h=>{
    const row = DATA[h.i];
    return `<tr>${COLS.map(c=>`<td style="padding:10px;border-bottom:1px solid #f1f1f1;white-space:nowrap;">${esc(pick(row,c)??"")}</td>`).join('')}</tr>`;
  }).join('');

  out.innerHTML = `
  <table>
    <thead><tr>${COLS.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}
</script>
</body>
</html>
